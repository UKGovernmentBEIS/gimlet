services:
  server:
    image: debian:bookworm-slim
    command: ["/app/gimlet-server-${ARCH:-amd64}"]
    deploy:
      replicas: 2
    environment:
      - GORACE=halt_on_error=1  # Exit immediately if race detected (for race-enabled builds)
      - GIMLET_SERVER_HTTP_PORT=8080
      - GIMLET_SERVER_LOG_LEVEL=DEBUG
      - GIMLET_SERVER_TOKEN_PUBLIC_KEY_FILE=/keys/jwt-signing-key.pub
      - GIMLET_SERVER_MAX_CONCURRENT_REQUESTS=60  # Allows E2E tests (50 concurrent) + room for rate limit testing
    volumes:
      - ../../bin:/app:ro
      - ./credentials:/keys:ro
    restart: unless-stopped

  backend-v1:
    image: sharat87/httpbun:latest

  agent-v1-1:
    image: debian:bookworm-slim
    command: ["/app/gimlet-agent-${ARCH:-amd64}"]
    environment:
      - GORACE=halt_on_error=1  # Exit immediately if race detected (for race-enabled builds)
      - GIMLET_AGENT_SERVER_URL=ws://control.local:8080/agent
      - GIMLET_AGENT_TARGET_URL=http://backend-v1
      - GIMLET_AGENT_TOKEN_FILE=/keys/agent-v1-1.jwt
      - GIMLET_AGENT_LOG_LEVEL=DEBUG
      - GIMLET_AGENT_MAX_CONCURRENT_REQUESTS=30  # Allows E2E tests (~25 per agent) + room for rate limit testing
    volumes:
      - ../../bin:/app:ro
      - ./credentials:/keys:ro
    depends_on:
      - server
      - backend-v1
      - nginx
    restart: unless-stopped

  agent-v1-2:
    image: debian:bookworm-slim
    command: ["/app/gimlet-agent-${ARCH:-amd64}"]
    environment:
      - GORACE=halt_on_error=1  # Exit immediately if race detected (for race-enabled builds)
      - GIMLET_AGENT_SERVER_URL=ws://control.local:8080/agent
      - GIMLET_AGENT_TARGET_URL=http://backend-v1
      - GIMLET_AGENT_TOKEN_FILE=/keys/agent-v1-2.jwt
      - GIMLET_AGENT_LOG_LEVEL=DEBUG
      - GIMLET_AGENT_MAX_CONCURRENT_REQUESTS=30  # Allows E2E tests (~25 per agent) + room for rate limit testing
    volumes:
      - ../../bin:/app:ro
      - ./credentials:/keys:ro
    depends_on:
      - server
      - backend-v1
      - nginx
    restart: unless-stopped

  backend-v2:
    image: nginx:alpine
    volumes:
      - ./temp:/usr/share/nginx/html:ro
      - ./nginx/backend-v2-nginx.conf:/etc/nginx/conf.d/default.conf:ro

  agent-v2-1:
    image: debian:bookworm-slim
    command: ["/app/gimlet-agent-${ARCH:-amd64}"]
    environment:
      - GORACE=halt_on_error=1  # Exit immediately if race detected (for race-enabled builds)
      - GIMLET_AGENT_SERVER_URL=ws://control.local:8080/agent
      - GIMLET_AGENT_TARGET_URL=http://backend-v2
      - GIMLET_AGENT_TOKEN_FILE=/keys/agent-v2-1.jwt
      - GIMLET_AGENT_MAX_CONCURRENT_REQUESTS=30  # Allows E2E tests (~25 per agent) + room for rate limit testing
    volumes:
      - ../../bin:/app:ro
      - ./credentials:/keys:ro
    depends_on:
      - server
      - backend-v2
      - nginx
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    ports:
      - "8080:8080"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - server
    restart: unless-stopped
    networks:
      default:
        aliases:
          - control.local

  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.retention.time=1h'
      - '--web.enable-lifecycle'
    depends_on:
      - server
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_AUTH_DISABLE_LOGIN_FORM=true
      - GF_INSTALL_PLUGINS=yesoreyeram-infinity-datasource
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
    depends_on:
      - prometheus
    restart: unless-stopped
